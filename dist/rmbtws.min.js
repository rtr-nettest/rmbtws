var exports = {};
/*!******************************************************************************
 * @license
 * Copyright 2015-2017 Thomas Schreiber
 * Copyright 2017-2019 Rundfunk und Telekom Regulierungs-GmbH (RTR-GmbH)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * The source code for this project is available at
 * https://github.com/rtr-nettest/rmbtws
 *****************************************************************************!*/
function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var n;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(n="Object"===(n={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,s=Array(t);n<t;n++)s[n]=e[n];return s}function RMBTTest(e,t){var S,o,v=log.getLogger("rmbtws"),k=null,p=4194304,m=0,N=4096,E=!1,c=null,n=null,s=null,r=TestState.INIT,a=null,l={durationInitMs:2500,durationPingMs:1e4,durationUpMs:-1,durationDownMs:-1},i=new RMBTIntermediateResult,u=[],M={},y={},d=null,g=0,T=0,w=0,O=[],P=0;function R(e){void 0!==r&&r===e||(r=e,a=nowMs(),s&&s(e))}this.onError=function(e){n=e},this.onStateChange=function(e){s=e};var f=function(e){var t;v.debug("error occurred during websocket test:",e),e!==RMBTError.NOT_SUPPORTED&&R(TestState.ERROR),null!==n&&(t=n,n=null,t(e))};function h(n,e,s,o){try{n.socket=new WebSocket(e)}catch(e){return void f(RMBTError.SOCKET_INIT_FAILED)}n.socket.binaryType="arraybuffer",n.socket.onerror=o,n.socket.onclose=o,n.socket.onmessage=function(e){var t;0===e.data.indexOf("CHUNKSIZE")?(4===(t=e.data.trim().split(" ")).length?(N=parseInt(t[1]),m=parseInt(t[2]),p=parseInt(t[3])):(N=parseInt(t[1]),m=N),v.debug(n.id+": Chunksizes: min "+m+", max: "+p+", default: "+N)):0===e.data.indexOf("RMBTv")?(t=e.data.substring(5).trim(),0===(S.client_version=t).indexOf("1.")?E=!0:0===t.indexOf("0.3")?E=!1:v.warn("unknown server version: "+t)):"ACCEPT TOKEN QUIT\n"===e.data?n.socket.send("TOKEN "+s+"\n"):"OK\n"===e.data&&n.state===TestState.INIT?v.debug(n.id+": Token accepted"):"ERR\n"===e.data?(o(),v.error("got error msg")):0===e.data.indexOf("ACCEPT GETCHUNKS")&&n.triggerNextState()}}function A(e,t,n){P=e.reduce(function(e,t){return e+t}),v.debug("total: circa "+P/1e3+" KB/sec"),v.debug("total: circa "+8*P/1e6+" MBit/sec");var s,o=8*P/1e6,r=0,a=(Object.keys(t).forEach(function(e){e<o&&(r=t[e])}),r=Math.min(g,r),v.debug("set number of threads to be used in upcoming speed test to: "+r),P/(1e3/(S.measurementPointsTimespan/2)));return a-=a%1024,a=Math.max(m,a),a=Math.min(p,a),v.debug("calculated chunksize for upcoming speed test "+a/1024+" KB"),n&&(s=Number.POSITIVE_INFINITY,Object.keys(M).forEach(function(e){Math.abs(a-e)<Math.abs(a-s)?("string"==typeof e&&(e=parseInt(e)),s=e):(delete M[e],delete y[e])}),a=s,v.debug("fallback to existing chunksize for upcoming speed test "+a/1024+" KB")),{numThreads:r,chunkSize:a,bytesPerSecs:P}}function L(n,s){var o,r;n.socket.onmessage=function(e){var t;"PONG\n"===e.data?(t=nowNs(),r=t-o,n.socket.send("OK\n")):0===e.data.indexOf("TIME")&&((t=new RMBTPingResult).client=r,t.server=parseInt(e.data.substring(5)),t.timeNs=o,s(t))},o=nowNs(),n.socket.send("PING\n")}this.startTest=function(){void 0===globalThis.WebSocket?f(RMBTError.NOT_SUPPORTED):(R(TestState.INIT),c=new RMBTTestResult,o.getDataCollectorInfo(),o.obtainControlServerRegistration(function(n){g=parseInt(n.test_numthreads),d=new CyclicBarrier(g),l.durationDownMs=1e3*n.test_duration,l.durationUpMs=1e3*n.test_duration,null!==TestEnvironment.getTestVisualization()&&TestEnvironment.getTestVisualization().updateInfo(n.test_server_name,n.client_remote_ip,n.provider,n.test_uuid,n.open_test_uuid);function e(){function e(){R(TestState.INIT),c.beginTime=Date.now();for(var e=0;e<g;e++){var t=new RMBTTestThread(d);t.id=e,c.addThread(t.result),((_,b,e)=>{var t=(_.test_server_encryption?"wss://":"ws://")+_.test_server_address+":"+_.test_server_port,I=(v.debug(t),{IGNORE:function(){},CALLGLOBALHANDLER:function(e){e&&v.error("connection closed",e),f(RMBTError.CONNECT_FAILED)},TRYRECONNECT:function(){f(RMBTError.CONNECT_FAILED)}});b.onStateEnter(TestState.INIT_DOWN,function(){function s(){var e,t,r,a,i,n,u;t=g,r=T,a=function(e){v.debug(o.id+": "+e);var e=parseInt(e.substring(5)),t=nowMs();d<t-l?(O.push(g*T/(e/1e9)),o.socket.onmessage=c):(g<8||!E?g*=2:T=Math.min(2*T,p),s())},i=(e=o).socket,n=k*t,u=null,i.onmessage=function(e){var t,n,s,o;"string"!=typeof e.data&&(t=!1,u=null===u?new Uint8Array(e.data):(n=u,s=new Uint8Array(e.data),(o=new Uint8Array(n.length+s.length)).set(n,0),o.set(s,n.length),o),e.data.byteLength,u.length===r&&(t=!0),t&&255===u[u.length-1]?(i.onmessage=function(e){e=e.data;a(e)},i.send("OK\n"),y[r]=u.buffer,u=null):(M.hasOwnProperty(r)||(M[r]=[]),t&&(M[r].length<S.savedChunks&&M[r].push(u.buffer),u=null)))},v.debug(e.id+": downloading "+t+" chunks, "+n/1e3+" KB"),e="GETCHUNKS "+t+(r!==N?" "+r:"")+"\n",i.send(e)}var o,d,c,l,g,T;R(TestState.INIT_DOWN),v.debug(b.id+": start short download"),k=m,o=b,d=S.pretestDurationMs,c=o.socket.onmessage,l=nowMs(),g=1,T=k,s()}),b.onStateEnter(TestState.PING,function(){function r(e){if(a.result.pings.push(e),c.pings=_toConsumableArray(a.result.pings),u===S.numPings-1&&(l.durationPingMs=(a.result.pings[1].timeNs-a.result.pings[0].timeNs)/1e6*S.numPings,v.debug(a.id+": PING phase will take approx "+l.durationPingMs+" ms")),v.debug(a.id+": PING "+e.client+" ns client; "+e.server+" ns server"),u--,0<(u=0<S.doPingIntervalMilliseconds&&0===u&&performance.now()-d<S.doPingIntervalMilliseconds?1:u))a.socket.onmessage=function(e){"ACCEPT GETCHUNKS GETTIME PUT PUTNORESULT PING QUIT\n"===e.data?L(a,r):v.error("unexpected error during ping test")};else{for(var t=[],n=0;n<a.result.pings.length;n++)t.push(a.result.pings[n].client);c.ping_client_median=Math.median(t),c.ping_client_shortest=Math.min.apply(Math,t);for(var s=[],o=0;o<a.result.pings.length;o++)s.push(a.result.pings[o].server);c.ping_server_median=Math.median(s),c.ping_server_shortest=Math.min.apply(Math,s),v.debug(a.id+": median client: "+Math.round(c.ping_client_median/1e3)/1e3+" ms; median server: "+Math.round(c.ping_server_median/1e3)/1e3+" ms"),v.debug(a.id+": shortest client: "+Math.round(c.ping_client_shortest/1e3)/1e3+" ms; shortest server: "+Math.round(c.ping_server_shortest/1e3)/1e3+" ms"),a.socket.onmessage=i}}var a,i,u,d;R(TestState.PING),v.debug(b.id+": starting ping"),0===b.id?(i=(a=b).socket.onmessage,u=S.numPings,d=performance.now(),L(a,r)):b.triggerNextState()}),b.onStateEnter(TestState.DOWN,function(){var s,e,o,r,a,i,u,d,c,l,g;R(TestState.DOWN),0<O.length&&(e=A(O,S.downloadThreadsLimitsMbit,!1),T=e.numThreads,E&&(k=e.chunkSize),O=[]),b.id<T?(s=b,e=_.test_duration,a=s.socket.onmessage,u=i=0,d=-1,l=c=null,o=setInterval(function(){var e,t,n;null!==c&&d!==u&&(d=u,e=nowNs(),v.debug(s.id+": "+r+"|"+S.measurementPointsTimespan+"|"+e+"|"+u),t=new Uint8Array(c,c.byteLength-1,1),n=l-g,s.result.down.push({duration:n,bytes:i}),r=e,255<=t[0])&&(v.debug(s.id+": received end chunk"),clearInterval(o),s.socket.onmessage=function(e){v.debug(e.data),s.socket.onmessage=a},s.socket.send("OK\n"))},S.measurementPointsTimespan),s.socket.onmessage=function(e){u++,i+=e.data.byteLength,l=nowNs(),c=e.data},g=nowNs(),s.socket.send("GETTIME "+e+(k!==N?" "+k:"")+"\n")):(b.socket.onerror=I.IGNORE,b.socket.onclose=I.IGNORE,b.triggerNextState())}),b.onStateEnter(TestState.CONNECT_UPLOAD,function(){R(TestState.INIT_UP),b.socket.onerror=I.IGNORE,b.socket.onclose=I.IGNORE,b.socket.close(),h(b,t,_.test_token,I.CALLGLOBALHANDLER)}),b.onStateEnter(TestState.INIT_UP,function(){k=m;var i=b,u=S.pretestDurationMs;function d(){var e=i,t=g,n=T,s=function(e){v.debug(i.id+": "+e);var t=nowMs();u<t-l?(i.socket.onmessage=c,t=parseInt(e.substring(5)),O.push(g*T/(t/1e9))):(e=2*T,g<8||!y.hasOwnProperty(e)||!E?g*=2:T=Math.min(2*T,p),d())},o=e.socket;o.onmessage=function(e){0!==e.data.indexOf("OK")&&0!==e.data.indexOf("ACCEPT")&&s(e.data)},v.debug(e.id+": uploading "+t+" chunks, "+n*t/1e3+" KB"),o.send("PUTNORESULT"+(E?" "+n:"")+"\n");for(var r=0;r<t;r++){var a=void 0;a=r===t-1?y[n]:M[n][0],o.send(a)}}var c=i.socket.onmessage,l=nowMs(),g=1,T=k;setTimeout(function(){var e=nowMs()-l;v.debug("diff:"+(e-u)+" ("+(e-u)/u+" %)")},u),d()}),b.onStateEnter(TestState.UP,function(){var e,s,t,o,n,r,a,i,u,d,c,l,g,T,p,m;function f(){a=globalThis.document&&globalThis.document.hidden?r:n,globalThis.document&&v.debug("document visibility changed to: "+globalThis.document.hidden)}function h(){u||(v.debug(s.id+": is 7.2 sec in, got data for "+c),c<1e9*t&&l<3e3?(setTimeout(h,250),l+=250):(v.debug(s.id+": didn't finish, timeout extended by "+l+" ms, last info for "+c),s.socket.onerror=function(){},s.socket.onclose=function(){},s.socket.close(),s.socket.onmessage=o,v.debug(s.id+": socket now closed: "+s.socket.readyState),globalThis.document&&document.removeEventListener("visibilitychange",f),s.triggerNextState()))}R(TestState.UP),0<O.length&&(e=A(O,S.uploadThreadsLimitsMbit,!0),w=e.numThreads,E&&(k=e.chunkSize),O=[]),b.id<w?(s=b,t=_.test_duration,o=s.socket.onmessage,n=P/2/w,r=1.5*P/w,a=globalThis.document&&globalThis.document.hidden?r:n,globalThis.document&&globalThis.document.addEventListener("visibilitychange",f),i=Math.ceil(P/w/k),d=!(u=!1),c=-1,l=0,g=function(){if(s.socket.bufferedAmount<a)for(var e=0;e<i;e++)s.socket.send(M[k][e%M[k].length]);if(!d)return!1;setTimeout(g,0)},setTimeout(h,1e3*t+200),setTimeout(function(){d=!1,s.socket.onclose=function(){},s.socket.send(y[k]),s.socket.send("QUIT\n")},1e3*t),v.debug(s.id+": set timeout"),T=1e6*S.measurementPointsTimespan,p=/TIME (\d+) BYTES (\d+)/,m=/TIME (\d+)/,s.socket.onmessage=function(e){"OK\n"===e.data&&g();var t,n=p.exec(e.data);null!==n?(t={duration:parseInt(n[1]),bytes:parseInt(n[2])},T<t.duration-c&&(c=t.duration,s.result.up.push(t))):null!==(n=m.exec(e.data))&&(u=!0,v.debug("Upload duration: "+n[1]),s.socket.onmessage=o,globalThis.document)&&document.removeEventListener("visibilitychange",f)},s.socket.send("PUT"+(k!==N?" "+k:"")+"\n")):(b.socket.onerror=I.IGNORE,b.socket.onclose=I.IGNORE,b.socket.readyState!==WebSocket.CLOSED&&b.socket.close(),b.triggerNextState())}),b.onStateEnter(TestState.END,function(){b.socket.readyState!==WebSocket.CLOSED&&b.socket.close(),0===b.id&&e()}),b.setState(TestState.INIT),R(TestState.INIT),h(b,t,_.test_token,I.CALLGLOBALHANDLER)})(n,t,function(){v.info("All tests finished"),s.stop(),TestEnvironment.getTestVisualization().getGeoResults?c.geoLocations=TestEnvironment.getTestVisualization().getGeoResults():c.geoLocations=s.getResults(),c.calculateAll(),o.submitResults({client_language:"de",client_name:S.client,client_uuid:S.uuid,client_version:S.client_version,client_software_version:S.client_software_version,geoLocations:c.geoLocations,model:S.model,network_type:98,platform:S.platform,product:S.product,pings:c.pings,test_bytes_download:c.bytes_download,test_bytes_upload:c.bytes_upload,test_nsec_download:c.nsec_download,test_nsec_upload:c.nsec_upload,test_num_threads:T,num_threads_ul:w,test_ping_shortest:c.ping_server_shortest,test_speed_download:c.speed_download,test_speed_upload:c.speed_upload,test_token:n.test_token,test_uuid:n.test_uuid,time:c.beginTime,timezone:S.timezone,type:"DESKTOP",version_code:"1",speed_detail:c.speedItems,user_server_selection:S.userServerSelection},function(){R(TestState.END)},function(){f(RMBTError.SUBMIT_FAILED)})}),u.push(t)}}v.debug("got geolocation, obtaining token and websocket address"),0===n.test_wait?e():(v.info("test scheduled for start in "+n.test_wait+" second(s)"),R(TestState.WAIT),self.setTimeout(function(){e()},1e3*n.test_wait))}var s;null!==TestEnvironment.getGeoTracker()?(s=TestEnvironment.getGeoTracker(),e()):(s=new GeoTracker,v.debug("getting geolocation"),s.start(function(){e()},TestEnvironment.getTestVisualization()))},function(){f(RMBTError.REGISTRATION_FAILED)}))},this.getIntermediateResult=function(){i.status=r;var e,t=nowNs()/1e6-a;switch(i.status){case TestState.WAIT:i.progress=0;break;case TestState.INIT:case TestState.INIT_DOWN:case TestState.INIT_UP:i.progress=t/l.durationInitMs;break;case TestState.PING:i.progress=t/l.durationPingMs;break;case TestState.DOWN:i.progress=t/l.durationDownMs;break;case TestState.UP:i.progress=t/l.durationUpMs;break;case TestState.END:i.progress=1;break;case TestState.ERROR:case TestState.ABORTED:i.progress=0}return isNaN(i.progress)&&(i.progress=0),i.progress=Math.min(1,i.progress),null!==c&&(i.status!==TestState.PING&&i.status!==TestState.DOWN||(i.pingNano=c.ping_server_median,i.pings=c.pings),i.status!==TestState.DOWN&&i.status!=TestState.INIT_UP||(e=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(c.threads,function(e){return e.down}),i.downBitPerSec=e.speed,i.downBitPerSecLog=(Math.log10(i.downBitPerSec/1e6)+2)/4),i.status!==TestState.UP&&i.status!=TestState.INIT_UP||(e=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(c.threads,function(e){return e.up}),i.upBitPerSec=e.speed,i.upBitPerSecLog=(Math.log10(i.upBitPerSec/1e6)+2)/4)),i},this.getState=function(){return"INIT"},S=e,o=t}Object.defineProperty(exports,"__esModule",{value:!0}),exports.RMBTTest=RMBTTest;
var curGeoPos,geo_callback,loc_timeout;function runCallback(){null!=geo_callback&&"function"==typeof geo_callback&&setTimeout(function(){geo_callback()},1)}function getCurLocation(){return curGeoPos}function getLocation(o,e,t,n){var a=globalThis.document&&globalThis.document.getElementById("infogeo");geo_callback=n,navigator.geolocation?(runCallback(),TestEnvironment.getGeoTracker().start(function(o,e){if(!0!==o&&a)if(e)switch(e.code){case e.PERMISSION_DENIED:a.innerHTML=Lang.getString("NoPermission");break;case e.TIMEOUT:break;case e.POSITION_UNAVAILABLE:a.innerHTML=Lang.getString("NotAvailable");break;case e.UNKNOWN_ERROR:a.innerHTML=Lang.getString("NotAvailable")+"("+e.code+")"}else a.innerHTML=Lang.getString("NotAvailable")},TestEnvironment.getTestVisualization())):((n=getCookie("coords"))?(n=JSON.parse(n))&&0<n.lat&&0<n.long&&testVisualization.setLocation(n.lat,n.long):a&&(a.innerHTML=Lang.getString("NotSupported")),runCallback())}Object.defineProperty(exports,"__esModule",{value:!0}),exports.GeoTracker=void 0;var GeoTracker=exports.GeoTracker=(()=>{var n,t,a,i,r=null;function o(){i=!(n=[])}o.prototype.start=function(o,e){t=o,void 0!==e&&(r=e),navigator.geolocation?(navigator.geolocation.getCurrentPosition(function(o){0===n.length&&(i=!0,c(o))},l,{enableHighAccuracy:!1,timeout:2e3,maximumAge:6e4}),a=navigator.geolocation.watchPosition(c,l,{enableHighAccuracy:!0,timeout:1/0,maximumAge:0})):(o=t,t=null,o(!1)),setTimeout(function(){l()},2e3)};var c=function(o){1===n.length&&(i=i&&!(n=[])),n.push({geo_lat:o.coords.latitude,geo_long:o.coords.longitude,accuracy:o.coords.accuracy,altitude:o.coords.altitude,bearing:o.coords.heading,speed:o.coords.speed,tstamp:o.timestamp,provider:"Browser"}),null!==t&&t(!(t=null)),null!==r&&r.setLocation(o.coords.latitude,o.coords.longitude),e(o)},l=function(o){var e;null!==t&&(e=t,t=null,e(!1,o))},e=function(o){var e={};e.lat=o.coords.latitude,e.long=o.coords.longitude,e.accuracy=o.coords.accuracy,e.altitude=o.coords.altitude,e.heading=o.coords.heading,e.speed=o.coords.speed,e.tstamp=o.timestamp,e=JSON.stringify(e),setCookie("coords",e,3600)};return o.prototype.stop=function(){navigator.geolocation&&navigator.geolocation.clearWatch(a)},o.prototype.getResults=function(){var t=null;return n=n.filter(function(e){return!(null!=t&&Object.keys(e).every(function(o){return t.hasOwnProperty(o)&&t[o]===e[o]})||(t=e,0))})},o})();void 0===globalThis.setCookie&&globalThis.document&&(globalThis.setCookie=function(o,e,t){var n=new Date,a=n.getTime(),a=(n.setTime(a+=1e3*t),encodeURIComponent(e)+(null==t?";":"; expires="+n.toUTCString()+";"));document.cookie=o+"="+a+" path=/;"});
Object.defineProperty(exports,"__esModule",{value:!0}),exports.RMBTControlServerCommunication=void 0;var RMBTControlServerCommunication=exports.RMBTControlServerCommunication=function(e,r){var i=e,s=log.getLogger("rmbtws"),o=(r=r||{}).register||null,u=r.submit||null,c=r.headers||{"Content-Type":"application/json"};return{obtainControlServerRegistration:function(r,t){var n,e={version:i.version,language:i.language,uuid:i.uuid,type:i.type,version_code:i.version_code,client:i.client,timezone:i.timezone,time:(new Date).getTime()};Object.assign(e,i.additionalRegistrationParameters),"undefined"!=typeof userServerSelection&&0<userServerSelection&&"undefined"!=typeof UserConf&&void 0!==UserConf.preferredServer&&"default"!==UserConf.preferredServer&&(e.prefer_server=UserConf.preferredServer,e.user_server_selection=userServerSelection),fetch(i.controlServerURL+i.controlServerRegistrationResource,{method:"POST",headers:c,body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){n=e;e=new RMBTControlServerRegistrationResponse(e);r(e)}).catch(function(e){n=e,s.error("error getting testID"),t()}).finally(function(){null!=o&&"function"==typeof o&&o({response:n,request:e})})},getDataCollectorInfo:function(){fetch(i.controlServerURL+i.controlServerDataCollectorResource,{method:"GET",headers:c}).then(function(e){return e.json()}).then(function(e){i.product=e.agent.substring(0,Math.min(150,e.agent.length)),i.model=e.product,i.os_version=e.version}).catch(function(){s.error("error getting data collection response")})},submitResults:function(r,t,n){Object.assign(r,i.additionalSubmissionParameters);var o,e=JSON.stringify(r);s.debug("Submit size: "+e.length),fetch(i.controlServerURL+i.controlServerResultResource,{method:"POST",headers:c,body:e}).then(function(e){return e.json()}).then(function(e){o=e,s.debug(r.test_uuid),t(!0)}).catch(function(e){o=e,s.error("error submitting results"),n(!1)}).finally(function(){null!==u&&"function"==typeof u&&u({response:o,request:r})})}}};
Object.defineProperty(exports,"__esModule",{value:!0}),exports.TestEnvironment=void 0;var TestEnvironment=exports.TestEnvironment=(()=>{var r=null,n=null;return{getTestVisualization:function(){return r},getGeoTracker:function(){return n},init:function(e,t){void 0===e&&(e=new TestVisualization),void 0===t&&(t=new GeoTracker),r=e,n=t}}})(),TestState={WAIT:"WAIT",INIT:"INIT",INIT_DOWN:"INIT_DOWN",PING:"PING",DOWN:"DOWN",CONNECT_UPLOAD:"CONNECT_UPLOAD",INIT_UP:"INIT_UP",UP:"UP",END:"END",ERROR:"ERROR",ABORTED:"ABORTED",LOCATE:"LOCATE",LOCABORTED:"LOCABORTED",SPEEDTEST_END:"SPEEDTEST_END",QOS_TEST_RUNNING:"QOS_TEST_RUNNING",QOS_END:"QOS_END"};function RMBTIntermediateResult(){}RMBTIntermediateResult.prototype.setLogValues=function(){function e(e){return e<1e4?0:(2+Math.log(e/1e6/Math.LN10))/4}this.downBitPerSecLog=e(downBitPerSec),this.upBitPerSecLog=e(upBitPerSec)},RMBTIntermediateResult.prototype.pingNano=-1,RMBTIntermediateResult.prototype.downBitPerSec=-1,RMBTIntermediateResult.prototype.upBitPerSec=-1,RMBTIntermediateResult.prototype.status=TestState.INIT,RMBTIntermediateResult.prototype.progress=0,RMBTIntermediateResult.prototype.downBitPerSecLog=-1,RMBTIntermediateResult.prototype.upBitPerSecLog=-1,RMBTIntermediateResult.prototype.remainingWait=-1;
var TestVisualization=(()=>{function t(t,s){this.successCallback=t,this.errorCallback=s}return t.prototype.setRMBTTest=function(t){},t.prototype.updateInfo=function(t,s,a,o,c){},t.prototype.setStatus=function(t){var s;"ERROR"===t||"ABORTED"===t?this.errorCallback&&(s=this.errorCallback,this.errorCallback=null,s()):"END"===t&&null!==_successCallback&&(s=this.successCallback,this.successCallback=null,s())},t.prototype.setLocation=function(t,s){},t.prototype.startTest=function(){},t})();
Object.defineProperty(exports,"__esModule",{value:!0}),exports.RMBTTestConfig=void 0;var RMBTTestConfig=exports.RMBTTestConfig=(()=>{function t(t,e,o){this.language=t,this.controlServerURL=e+"/"+o,"undefined"!=typeof Intl&&Intl.DateTimeFormat().resolvedOptions().timeZone&&(this.timezone=Intl.DateTimeFormat().resolvedOptions().timeZone.replace("Europe/Berlin","Europe/Vienna"))}return t.prototype.version="0.3",t.prototype.uuid="",t.prototype.type="DESKTOP",t.prototype.version_code="0.3",t.prototype.client_version="0.3",t.prototype.client_software_version="0.9.4",t.prototype.os_version=1,t.prototype.platform="RMBTws",t.prototype.model="Websocket",t.prototype.product="Chrome",t.prototype.client="RMBTws",t.prototype.timezone="Europe/Vienna",t.prototype.controlServerRegistrationResource="/testRequest",t.prototype.controlServerResultResource="/result",t.prototype.controlServerDataCollectorResource="/requestDataCollector",t.prototype.pretestDurationMs=2e3,t.prototype.savedChunks=4,t.prototype.measurementPointsTimespan=40,t.prototype.numPings=10,t.prototype.doPingIntervalMilliseconds=-1,t.prototype.downloadThreadsLimitsMbit={0:1,1:3,100:5},t.prototype.uploadThreadsLimitsMbit={0:1,30:2,80:3,150:5},t.prototype.userServerSelection=void 0!==globalThis.userServerSelection?userServerSelection:0,t.prototype.additionalRegistrationParameters={},t.prototype.additionalSubmissionParameters={},t})(),RMBTControlServerRegistrationResponse=(()=>{function t(t){Object.assign(this,t),this.test_duration=parseInt(t.test_duration)}return t.prototype.test_server_encryption="",t})();function RMBTTestThread(t){var o=log.getLogger("rmbtws"),s={},r=t;return{setState:function(t){this.state=t,o.debug(this.id+": reached state: "+t);var e=this;r.await(function(){o.debug(e.id+": all threads reached state: "+t),null!=s[t]?(0,s[t])():o.info(e.id+": no callback registered for state: "+t)})},onStateEnter:function(t,e){s[t]=e},retriggerState:function(){setState(this.state)},triggerNextState:function(){var t=[TestState.INIT,TestState.INIT_DOWN,TestState.PING,TestState.DOWN,TestState.CONNECT_UPLOAD,TestState.INIT_UP,TestState.UP,TestState.END];this.state!==TestState.END&&(t=t[t.indexOf(this.state)+1],o.debug(this.id+": triggered state "+t),this.setState(t))},id:-1,socket:null,result:new RMBTThreadTestResult}}function RMBTTestResult(){this.pings=[],this.speedItems=[],this.threads=[]}function RMBTThreadTestResult(){this.down=[],this.up=[],this.pings=[]}function RMBTPingResult(){}RMBTTestResult.prototype.addThread=function(t){this.threads.push(t)},RMBTTestResult.prototype.ip_local=null,RMBTTestResult.prototype.ip_server=null,RMBTTestResult.prototype.port_remote=null,RMBTTestResult.prototype.num_threads=null,RMBTTestResult.prototype.encryption="NONE",RMBTTestResult.prototype.ping_shortest=-1,RMBTTestResult.prototype.ping_median=-1,RMBTTestResult.prototype.client_version=null,RMBTTestResult.prototype.pings=[],RMBTTestResult.prototype.speed_download=-1,RMBTTestResult.prototype.speed_upload=-1,RMBTTestResult.prototype.speedItems=[],RMBTTestResult.prototype.bytes_download=-1,RMBTTestResult.prototype.nsec_download=-1,RMBTTestResult.prototype.bytes_upload=-1,RMBTTestResult.prototype.nsec_upload=-1,RMBTTestResult.prototype.totalDownBytes=-1,RMBTTestResult.prototype.totalUpBytes=-1,RMBTTestResult.prototype.beginTime=-1,RMBTTestResult.prototype.geoLocations=[],RMBTTestResult.calculateOverallSpeedFromMultipleThreads=function(t,e){for(var o=t.length,s=1/0,r=0;r<o;r++){var n=e(t[r]);0<n.length&&n[n.length-1].duration<s&&(s=n[n.length-1].duration)}for(var i=0,p=0;p<o;p++){var a=t[p],l=e(a),u=l.length;if(null!==a&&0<u){for(var T=u,d=0;d<u;d++)if(l[d].duration>=s){T=d;break}var R,h,y;i+=l[T].duration===s?l[u-1].bytes:(a=0===T?0:l[T-1].bytes,y=l[T].bytes,R=0===T?0:l[T-1].duration,h=l[T].duration,a+(y=(y=Math.round((y-a)*((s-R)/(h-R))))<0?0:y))}}return{bytes:i,nsec:s,speed:8*i/(s/1e9)}},RMBTTestResult.prototype.calculateAll=function(){for(var t=0;t<this.threads.length;t++){var e=this.threads[t].down;if(0<e.length)for(var o=0;o<e.length;o++)this.speedItems.push({direction:"download",thread:t,time:e[o].duration,bytes:e[o].bytes})}var s=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(this.threads,function(t){return t.down});this.speed_download=s.speed/1e3,this.bytes_download=s.bytes,this.nsec_download=s.nsec;for(var r=0;r<this.threads.length;r++){var n=this.threads[r].up;if(0<n.length)for(var i=0;i<n.length;i++)this.speedItems.push({direction:"upload",thread:r,time:n[i].duration,bytes:n[i].bytes})}s=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(this.threads,function(t){return t.up}),this.speed_upload=s.speed/1e3,this.bytes_upload=s.bytes,this.nsec_upload=s.nsec;for(var p=this.threads[0].pings,a=[],l=0;l<p.length;l++)a.push({value:p[l].client,value_server:p[l].server,time_ns:p[l].timeNs});this.pings=a;for(var u=0;u<this.geoLocations.length;u++){var T=this.geoLocations[u];T.time_ns=1e6*(T.tstamp-this.beginTime)}},RMBTThreadTestResult.prototype.down=null,RMBTThreadTestResult.prototype.up=null,RMBTThreadTestResult.prototype.pings=null,RMBTThreadTestResult.prototype.totalDownBytes=-1,RMBTThreadTestResult.prototype.totalUpBytes=-1,RMBTPingResult.prototype.client=-1,RMBTPingResult.prototype.server=-1,RMBTPingResult.prototype.timeNs=-1;var RMBTError={NOT_SUPPORTED:"WebSockets are not supported",SOCKET_INIT_FAILED:"WebSocket initialization failed",CONNECT_FAILED:"connection to test server failed",SUBMIT_FAILED:"Error during submission of test results",REGISTRATION_FAILED:"Error during test registration"};
function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,n,t){return n&&_defineProperties(e.prototype,n),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,n){if("object"!=_typeof(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0===t)return("string"===n?String:Number)(e);t=t.call(e,n||"default");if("object"!=_typeof(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}function nowMs(){return performance.now()}function nowNs(){return Math.round(1e6*performance.now())}function CyclicBarrier(e){var t=e,o=[];return{await:function(e){var n;o.push(e),o.length===t&&(n=o.slice(),o=[],self.setTimeout(function(){for(var e=0;e<t;e++)n[e]()},1))}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.log=void 0,(()=>{var e;Date.now||(Date.now=function(){return(new Date).getTime()}),(performance="undefined"==typeof performance?{}:performance).now&&void 0!==performance.now||(e=Date.now(),performance.timing&&performance.timing.navigationStart&&(e=performance.timing.navigationStart),performance.now=function(){return Date.now()-e})})(),Math.median=function(e){e.sort(function(e,n){return e-n});var n=Math.floor(e.length/2);return e.length%2?e[n]:(e[n-1]+e[n])/2},Math.log10=Math.log10||function(e){return Math.log(e)/Math.LN10};var Log=(()=>_createClass(function e(){_classCallCheck(this,e)},[{key:"debug",value:function(){var e;(e=console).log.apply(e,arguments)}},{key:"trace",value:function(){console.trace()}},{key:"info",value:function(){var e;(e=console).info.apply(e,arguments)}},{key:"warn",value:function(){var e;(e=console).warn.apply(e,arguments)}},{key:"error",value:function(){var e;(e=console).error.apply(e,arguments)}},{key:"disable",value:function(){this.debug=function(){},this.trace=function(){},this.info=function(){},this.warn=function(){}}},{key:"setLevel",value:function(){}},{key:"getLogger",value:function(){return this}}]))(),log=(self.log=self.log||new Log,exports.log=self.log);"function"!=typeof Object.assign&&(Object.assign=function(e,n){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),o=1;o<arguments.length;o++){var r=arguments[o];if(null!=r)for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}),globalThis.document&&void 0===document.hidden&&(document.hidden=!1);
//# sourceMappingURL=rmbtws.min.js.map
